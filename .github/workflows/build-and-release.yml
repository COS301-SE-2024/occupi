name: Build and Release all

on:
  push:
    branches:
      - action-needs-refinement-lol

jobs:
    build-backend-binary:
        strategy:
          matrix:
            include:
              - os: macos-latest # for Arm based macs (M1 and above).
                goos: darwin
                extension: ""
                args: '--target aarch64-apple-darwin'
                arch: arm64
              - os: macos-latest # for Intel based macs.
                goos: darwin
                extension: ""
                args: '--target x86_64-apple-darwin'
                arch: x86_64
              - os: windows-latest # for Windows.
                goos: windows
                extension: ".exe"
                args: ''
                arch: x86_64
              - os: ubuntu-latest # for Linux.
                goos: linux
                extension: ""
                args: ''
                arch: x86_64

        name: Build Backend Binary
        runs-on: ${{ matrix.os }}

        steps:
          - name: Checkout code
            uses: actions/checkout@v4
    
          - name: Set up Go
            uses: actions/setup-go@v5
            with:
              go-version: '1.21'  # Specify the Go version you are using
    
          - name: Build application
            run: |
              cd occupi-backend
              go build -o occupi-backend_${{ matrix.goos }}_${{ matrix.arch }}${{ matrix.extension }} ${{ matrix.args }} -v cmd/occupi-backend/main.go
    
          - name: Upload artifact
            uses: actions/upload-artifact@v3
            with:
              name: occupi-backend_${{ matrix.goos }}_${{ matrix.arch }}${{ matrix.extension }}
              path: occupi-backend/occupi-backend_${{ matrix.goos }}_${{ matrix.arch }}${{ matrix.extension }}

    build-android:
      runs-on: ubuntu-latest
      steps:
        - name: Setup repo
          uses: actions/checkout@v4
        
        - name: Setup node
          uses: actions/setup-node@v4.0.2
          with:
            node-version: 18.x
            cache: 'npm'

        - name: Set up JDK 17
          uses: actions/setup-java@v4
          with:
            java-version: '17'
            distribution: 'temurin'

        - name: Setup Android SDK
          uses: android-actions/setup-android@v3

        - name: Setup Expo
          uses: expo/expo-github-action@v8
          with:
            expo-version: latest
            eas-version: latest
            token: ${{ secrets.EXPO_TOKEN }}

        - name: Install dependencies
          run: npm ci

        - name: Build Android app
          run: eas build --platform android --profile preview --local --output ${{ github.workspace }}/app-release.apk

        - name: Upload APK artifact
          uses: actions/upload-artifact@v4
          with:
            name: app-release
            path: ${{ github.workspace }}/app-release.apk

    build-ios:
      runs-on: macos-latest
      steps:
        - name: Setup repo
          uses: actions/checkout@v4
        
        - name: Setup node
          uses: actions/setup-node@v4.0.2
          with:
            node-version: 18.x
            cache: 'npm'

        - name: Setup Expo
          uses: expo/expo-github-action@v8
          with:
            expo-version: latest
            eas-version: latest
            token: ${{ secrets.EXPO_TOKEN }}

        - name: Install dependencies
          run: npm ci

        - name: Build iOS app
          run: eas build --platform ios --local --non-interactive --output ${{ github.workspace }}/app-release.ipa

        - name: Upload IPA artifact
          uses: actions/upload-artifact@v4
          with:
            name: app-release
            path: ${{ github.workspace }}/app-release.ipa

    build-vite-app:
        name: Build Vite App
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup Bun
              uses: oven-sh/setup-bun@v1
              with:
                bun-version: latest # or "latest", "canary", <sha>

            - name: Install dependencies with Bun
              run: |
                cd frontend/occupi-web
                bun install

            - name: Build with Vite
              run: |
                cd frontend/occupi-web
                bun run build
            
            - name: Archive Vite App from dist folder
              run: |
                zip -r dist/occupi-web.zip frontend/occupi-web/dist

            - name: Upload artifact
              uses: actions/upload-artifact@v3
              with:
                  name: occupi-web
                  path: frontend/occupi-web/dist/occupi-web.zip

    build-tauri-app:
        strategy:
            matrix:
              include:
                - os: macos-latest # for Arm based macs (M1 and above).
                  goos: darwin
                  extension: ""
                  args: '--target aarch64-apple-darwin'
                  arch: arm64
                - os: macos-latest # for Intel based macs.
                  goos: darwin
                  extension: ""
                  args: '--target x86_64-apple-darwin'
                  arch: x86_64
                - os: windows-latest # for Windows.
                  goos: windows
                  extension: ".exe"
                  args: ''
                  arch: x86_64
                - os: ubuntu-latest # for Linux.
                  goos: linux
                  extension: ""
                  args: ''
                  arch: x86_64

        name: Build Tauri App
        runs-on: ${{ matrix.os }}
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Bun
              uses: oven-sh/setup-bun@v1
              with:
                bun-version: latest # or "latest", "canary", <sha>

            - name: Install dependencies with Bun
              run: |
                cd frontend/occupi-desktop
                bun install

            - name: Build with Tauri
              run: |
                cd frontend/occupi-desktop
                bun run tauri build

            - name: Archive and Upload MacOS Tauri App
              if: startsWith(matrix.os, 'macos')
              run: |
                mkdir -p tauri_artifacts
                cp -R src-tauri/target/release/bundle/dmg/* tauri_artifacts/ || true
                cp -R src-tauri/target/release/bundle/macos/* tauri_artifacts/ || true

            - name: Archive and Upload Windows Tauri App
              if: startsWith(matrix.os, 'windows')
              run: |
                mkdir -p tauri_artifacts
                cp -R src-tauri/target/release/bundle/nsis/* tauri_artifacts/ || true
                cp -R src-tauri/target/release/bundle/msi/* tauri_artifacts/ || true

            - name: Archive and Upload Linux Tauri App
              if: startsWith(matrix.os, 'ubuntu')
              run: |
                mkdir -p tauri_artifacts
                cp -R src-tauri/target/release/bundle/deb/* tauri_artifacts/ || true
                cp -R src-tauri/target/release/bundle/appimage/* tauri_artifacts/ || true
                cp -R src-tauri/target/release/bundle/rpm/* tauri_artifacts/ || true
                cp -R src-tauri/target/release/bundle/flatpak/* tauri_artifacts/ || true
        
            - name: Upload Tauri Artifacts
              uses: actions/upload-artifact@v4
              with:
                name: tauri-artifacts-${{ matrix.os }}
                path: frontend/occupi-desktop/tauri_artifacts

    release:
        name: Release
        runs-on: ubuntu-latest
        needs: [build-backend-binary, build-android, build-ios, build-vite-app, build-tauri-app]
        steps:
            - name: Install GitHub CLI
              run: |
                sudo apt-key adv --keyserver keyserver.ubuntu.com --recv-key C99B11DEB97541F0
                sudo apt-add-repository https://cli.github.com/packages
                sudo apt update
                sudo apt install gh

            - name: Login to GitHub
              run: |
                gh auth login

            - name: Create a Release
              run: |
                gh release create v1.0.0 -t "v1.0.0" -n "v1.0.0" ./occupi-backend/occupi-backend ./occupi-frontend/occupi-frontend ./occupi-frontend/dist ./occupi-frontend/build ./occupi-frontend/target/release/occupi-frontend

            - name: Upload Release Assets
              run: |
                gh release upload v1.0.0 ./occupi-backend/occupi-backend ./occupi-frontend/occupi-frontend ./occupi-frontend/dist ./occupi-frontend/build ./occupi-frontend/target/release/occupi-frontend